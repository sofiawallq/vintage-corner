{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12 text-center">
            <h2>Reviews</h2>
        </div>
    </div>

    <!-- Sorting options -->
    <div class="row">
        <div class="col-12 col-md-6">
            <form method="get" action="{% url 'review_list' %}">
                <select name="sort" onchange="this.form.submit()">
                    <option value="">Sort by:</option>
                    <option value="date" {% if current_sort == 'date' %}selected{% endif %}>Latest</option>
                    <option value="product" {% if current_sort == 'product' %}selected{% endif %}>Product name</option>
                </select>
            </form>
        </div>
    </div>

    {% if user.is_authenticated %}
    <!-- Form for adding a new review -->
    <div class="row mt-4">
        <div class="col-12 col-md-6">
            <h3>Add a new review</h3>
            <form method="post">
                {% csrf_token %}
                {{ form | crispy }}
                <button class="btn btn-secondary" type="submit">Submit</button>
            </form>
        </div>
    </div>
    {% else %}
    <p>You must be logged in to add a review.</p>
    {% endif %}

    <!-- Displaying reviews -->
    <div class="row mt-4">
        {% for review in reviews %}
        <div class="col-12">
            <h4>{{ review.product.name }}</h4>
            <p>{{ review.comment }}</p>
            <small>Posted on: {{ review.created_at }}</small>

            {% if user.is_authenticated %}
            <!-- Form for responding to the review -->
            <div class="mt-3">
                <h5>Respond to this review</h5>
                <form method="post">
                    {% csrf_token %}
                    {{ response_form | crispy }}
                    <input type="hidden" name="review_id" value="{{ review.id }}">
                    <button class="btn btn-secondary" type="submit">Submit</button>
                </form>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <p>No reviews available.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}